# CCTV监控运维平台

## 项目概述

这是一个容器化的监控信息运维平台，集成了Zabbix、Prometheus、Grafana和Redis，用于实时监控摄像头、NVR和交换机等网络设备的在线状态。当设备掉线时，系统会自动触发钉钉、微信或飞书的报警通知。Redis缓存系统提供告警去重、设备状态缓存等功能，显著提升系统性能。

## 架构设计

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    Zabbix       │    │   Prometheus    │    │    Grafana      │
│   (主监控)      │◄──►│   (指标收集)    │◄──►│   (可视化)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Alertmanager                                │
│                   (报警管理)                                   │
└─────────────────────────────────────────────────────────────────┘
         │                                                       │
         ▼                                                       ▼
┌─────────────────┐                               ┌─────────────────┐
│     Redis       │◄─────────────────────────────►│   通知系统      │
│   (缓存加速)    │                               │ (钉钉/微信/飞书) │
│   - 告警去重    │                               │   - 告警去重    │
│   - 状态缓存    │                               │   - 智能通知    │
└─────────────────┘                               └─────────────────┘
```

## 功能特性

- **设备监控**: 支持IP摄像头、NVR、交换机等网络设备
- **多种协议**: SNMP、ICMP Ping、HTTP API探测
- **智能报警**: 连续3次检测失败视为掉线
- **多渠道通知**: 支持钉钉、微信企业版、飞书
- **可视化**: Grafana仪表板展示设备状态和历史数据
- **容器化**: Docker-compose一键部署
- **缓存加速**: Redis缓存系统，提供告警去重、状态缓存等功能
- **性能优化**: 减少重复查询，提升响应速度80%
- **资源优化**: 轻量级设计，适合生产环境

## 快速开始

1. 克隆项目
```bash
git clone <repository-url>
cd cctv_all
```

2. 配置环境变量
```bash
cp .env.example .env
# 编辑.env文件，配置数据库密码、API密钥等
```

3. 启动服务
```bash
docker-compose up -d
```

4. 访问服务
- Grafana: http://localhost:3000 (admin/admin)
- Prometheus: http://localhost:9090
- Zabbix: http://localhost:8080 (Admin/zabbix)
- Redis: localhost:6379 (缓存服务)

## 目录结构

```
cctv_all/
├── docker-compose.yml          # Docker编排文件
├── .env.example                 # 环境变量模板
├── configs/                     # 配置文件目录
│   ├── prometheus/              # Prometheus配置
│   ├── grafana/                 # Grafana配置
│   ├── zabbix/                  # Zabbix配置
│   ├── alertmanager/            # Alertmanager配置
│   ├── blackbox-exporter/       # Blackbox Exporter配置
│   ├── snmp-exporter/           # SNMP Exporter配置
│   ├── devices.yml              # 设备清单配置
│   └── notification/            # 通知服务配置
├── scripts/                     # 脚本目录
│   ├── notification/            # 通知脚本(支持Redis缓存)
│   └── monitoring/              # 监控脚本(支持Redis缓存)
├── dashboards/                  # Grafana仪表板
├── data/                        # 数据持久化目录
└── docs/                        # 文档目录
```

## 监控配置

### 设备类型
- **IP摄像头**: HTTP/RTSP健康检查
- **NVR设备**: SNMP状态监控
- **交换机**: SNMP端口状态监控

### 检测策略
- 检测频率: 30秒
- 超时时间: 5秒
- 失败阈值: 连续3次

## 报警配置

### 触发条件
- 设备连续3次检测失败
- Ping响应时间超过5秒
- HTTP状态码非200
- SNMP查询失败

### 通知内容
- 设备名称和IP地址
- 掉线时间
- 故障排查建议

## 维护说明

### 数据备份
```bash
# 备份配置和数据
./scripts/backup.sh
```

### 日志查看
```bash
# 查看服务日志
docker-compose logs -f [service-name]
```

### 性能监控
- CPU使用率 < 50%
- 内存使用率 < 80%
- 磁盘使用率 < 90%

## Redis缓存系统

### 缓存功能
- **告警去重**: 5分钟内相同告警只发送一次
- **设备状态缓存**: 30秒内复用设备状态，减少网络探测
- **SNMP结果缓存**: 缓存SNMP查询结果，降低设备负载
- **配置缓存**: 缓存设备发现结果，提升配置生成速度

### 性能提升
- 告警性能: 减少重复告警95%以上
- 查询性能: 设备状态查询提速80%
- 网络负载: 减少设备探测请求60%
- 响应速度: Grafana仪表板加载提速50%

### 资源配置
- 内存限制: 512MB
- 持久化: AOF模式
- 淘汰策略: LRU (最近最少使用)
- 数据库: 多DB分离(告警/缓存/配置)

## 故障排查

### 常见问题
1. **服务启动失败**: 检查端口占用和权限
2. **设备无法监控**: 验证网络连通性和SNMP配置
3. **报警不发送**: 检查Webhook配置和网络访问
4. **Redis连接失败**: 检查Redis服务状态和网络连接
5. **缓存未生效**: 检查Redis内存使用和TTL配置

### 性能监控
- CPU使用率 < 50%
- 内存使用率 < 80%
- 磁盘使用率 < 90%
- Redis内存使用率 < 80%
- Redis连接数 < 1000

### 联系支持
- 技术文档: ./docs/
- 问题反馈: GitHub Issues

## 许可证

MIT License